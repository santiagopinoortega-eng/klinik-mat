// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // ¡Ojo! Usaremos la URL de solo lectura si está disponible, 
  // sino la principal. (Ya manejado en lib/prisma.ts)
  url       = env("DATABASE_URL")
}

// ------------------------------------------------------------------
// 1. Modelo Case (Caso Clínico) - El centro de KLINIK-MAT
// ------------------------------------------------------------------
model Case {
  id              String         @id @default(cuid())
  title           String         // Nombre del caso (ej: Embarazo Ectópico)
  area            String         // (ej: Ginecología, Obstetricia)
  difficulty      Int            // 1 (Fácil) - 5 (Difícil)
  summary         String?        // Breve resumen para el listado de casos
  isPublic        Boolean        @default(false)
  
  // Vignette: El cuerpo principal y narrativo del caso clínico
  vignette        String?        
  
  // Relaciones
  questions       Question[]     @relation("CaseQuestions") // Pasos renombrados a Questions
  norms           MinsalNorm[]   @relation("CaseNorms")     // Normas MINSAL aplicables

  // Tiempos (Práctica recomendada de nomenclatura: CamelCase en Prisma, Snake_case en DB)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Renombrando los campos existentes para estandarización
  @@map("case") 
}

// ------------------------------------------------------------------
// 2. Modelo Question (Pregunta) - Refactorización de 'Paso'
// ------------------------------------------------------------------
// Un Case tiene múltiples Questions. Una Question tiene múltiples Options.
model Question {
  id              String         @id @default(cuid())
  order           Int            // Orden de aparición dentro del caso
  text            String         // Texto completo de la pregunta

  // Relación con el Case (1:N)
  case            Case           @relation("CaseQuestions", fields: [caseId], references: [id])
  caseId          String
  
  // Relación con Options (1:N)
  options         Option[]       @relation("QuestionOptions")

  @@map("questions")
}

// ------------------------------------------------------------------
// 3. Modelo Option (Opción de Respuesta) - Nuevo para integridad
// ------------------------------------------------------------------
// Esto reemplaza el campo 'opciones' Json en el modelo Paso anterior
model Option {
  id              String         @id @default(cuid())
  text            String
  isCorrect       Boolean        @default(false) // La clave para la lógica de corrección

  // Feedback: Crucial para el aprendizaje clínico (Por qué está bien/mal)
  feedback        String?        

  // Relación con Question (N:1)
  question        Question       @relation("QuestionOptions", fields: [questionId], references: [id])
  questionId      String

  @@map("options")
}

// ------------------------------------------------------------------
// 4. Modelo MinsalNorm (Norma MINSAL) - Estandarización
// ------------------------------------------------------------------
model MinsalNorm {
  id              String         @id @default(cuid())
  name            String         @map("nombre")
  code            String         @unique @map("codigo") // El código debe ser único
  
  // Relación N:M con Case
  cases           Case[]         @relation("CaseNorms")

  @@map("minsal_norms")
}

// ------------------------------------------------------------------
// 5. Modelo User (Usuario) - Para gestión y autenticación futura
// ------------------------------------------------------------------
model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  password  String    // En un futuro, esto almacenará un hash, no texto plano.
  role      UserRole  @default(USER)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}